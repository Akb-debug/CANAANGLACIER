{% extends 'dashboards/base.html' %}
{% load static %}

{% block title %}Liste des Utilisateurs - Admin{% endblock %}

{% block body %}
<div class="container-fluid pt-4 px-4">
    <!-- Messages dynamiques -->
    <div id="messagesContainer"></div>

    <div class="row g-4">
        <div class="col-12">
            <div class="bg-white rounded h-100 p-4 shadow-sm">
                <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between mb-4 gap-3">
                <h4 class="mb-0 teal-glacier-text flex-shrink-0">
                    <i class="fas fa-users me-2"></i>
                    Gestion des Utilisateurs
                </h4>
                <div class="d-flex flex-wrap gap-2 w-100 w-md-auto justify-content-center justify-content-md-end">
                    <!-- Bouton Retour - toujours visible -->
                    <a href="{% url 'dashboard_admin' %}" class="btn btn-outline-teal btn-sm flex-shrink-0">
                        <i class="fas fa-arrow-left me-1"></i>
                        <span class="d-none d-sm-inline">Retour</span>
                    </a>
                    
                    <!-- Boutons principaux - visibles sur desktop, menu déroulant sur mobile -->
                    <div class="dropdown d-md-none">
                        <button class="btn btn-teal-glacier btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-plus me-1"></i>
                            Actions
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a href="{% url 'creer_gerant' %}" class="dropdown-item">
                                    <i class="fas fa-user-tie me-2"></i>
                                    Nouveau Gérant
                                </a>
                            </li>
                            <li>
                                <a href="{% url 'creer_serveur_gerant' %}" class="dropdown-item">
                                    <i class="fas fa-user-cog me-2"></i>
                                    Nouveau Serveur
                                </a>
                            </li>
                            <li>
                                <a href="{% url 'ajouter_livreur' %}" class="dropdown-item">
                                    <i class="fas fa-truck me-2"></i>
                                    Nouveau Livreur
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a href="{% url 'gestion_utilisateurs' %}" class="dropdown-item">
                                    <i class="fas fa-users me-2"></i>
                                    Utilisateurs
                                </a>
                            </li>
                        </ul>
                    </div>
                    
                    <!-- Boutons visibles sur tablette et desktop -->
                    <div class="d-none d-md-flex gap-2">
                        <a href="{% url 'creer_gerant' %}" class="btn btn-teal-glacier btn-sm">
                            <i class="fas fa-user-tie me-1"></i>
                            Nouveau Gérant
                        </a>
                        <a href="{% url 'creer_serveur_gerant' %}" class="btn btn-teal-glacier btn-sm">
                            <i class="fas fa-user-cog me-1"></i>
                            Nouveau Serveur
                        </a>
                        <a href="{% url 'ajouter_livreur' %}" class="btn btn-teal-glacier btn-sm">
                            <i class="fas fa-truck me-1"></i>
                            Nouveau Livreur
                        </a>
                        <a href="{% url 'gestion_utilisateurs' %}" class="btn btn-teal-glacier btn-sm">
                            <i class="fas fa-users me-1"></i>
                            Utilisateurs
                        </a>
                    </div>
                </div>
            </div>
                <!-- Statistiques rapides -->
                <div class="row mb-4">
                    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                        <div class="bg-teal-glacier text-white rounded p-3 text-center card-hover">
                            <h5 class="mb-0 text-white">{{ utilisateurs.admins.count }}</h5>
                            <small>Administrateurs</small>
                        </div>
                    </div>
                    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                        <div class="bg-teal-glacier text-white rounded p-3 text-center card-hover">
                            <h5 class="mb-0 text-white">{{ utilisateurs.gerants.count }}</h5>
                            <small>Gérants</small>
                        </div>
                    </div>
                    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                        <div class="bg-teal-glacier text-white rounded p-3 text-center card-hover">
                            <h5 class="mb-0 text-white">{{ utilisateurs.serveurs.count }}</h5>
                            <small>Serveurs</small>
                        </div>
                    </div>
                    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                        <div class="bg-teal-glacier text-white rounded p-3 text-center card-hover">
                            <h5 class="mb-0 text-white">{{ utilisateurs.livreurs.count }}</h5>
                            <small>Livreurs</small>
                        </div>
                    </div>
                    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                        <div class="bg-teal-glacier text-white rounded p-3 text-center card-hover">
                            <h5 class="mb-0 text-white">{{ utilisateurs.clients.count }}</h5>
                            <small>Clients</small>
                        </div>
                    </div>
                    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                        <div class="bg-teal-glacier text-white rounded p-3 text-center card-hover">
                            <h5 class="mb-0 text-white">{{ total_utilisateurs }}</h5>
                            <small>Total</small>
                        </div>
                    </div>
                </div>

                <!-- Tabs pour les différents rôles -->
                <ul class="nav nav-tabs mb-3" id="usersTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="admins-tab" data-bs-toggle="tab" data-bs-target="#admins" type="button" role="tab">
                            <i class="fas fa-user-shield me-1"></i>
                            Admins ({{ utilisateurs.admins.count }})
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="gerants-tab" data-bs-toggle="tab" data-bs-target="#gerants" type="button" role="tab">
                            <i class="fas fa-user-tie me-1"></i>
                            Gérants ({{ utilisateurs.gerants.count }})
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="serveurs-tab" data-bs-toggle="tab" data-bs-target="#serveurs" type="button" role="tab">
                            <i class="fas fa-user-cog me-1"></i>
                            Serveurs ({{ utilisateurs.serveurs.count }})
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="livreurs-tab" data-bs-toggle="tab" data-bs-target="#livreurs" type="button" role="tab">
                            <i class="fas fa-truck me-1"></i>
                            Livreurs ({{ utilisateurs.livreurs.count }})
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="clients-tab" data-bs-toggle="tab" data-bs-target="#clients" type="button" role="tab">
                            <i class="fas fa-user me-1"></i>
                            Clients ({{ utilisateurs.clients.count }})
                        </button>
                    </li>
                </ul>

                <!-- Contenu des tabs -->
                <div class="tab-content" id="usersTabContent">
                    <!-- Administrateurs -->
                    <div class="tab-pane fade show active" id="admins" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="teal-glacier-bg">
                                    <tr>
                                        <th class="text-white">Utilisateur</th>
                                        <th class="text-white">Nom complet</th>
                                        <th class="text-white">Email</th>
                                        <th class="text-white">Téléphone</th>
                                        <th class="text-white">Date d'inscription</th>
                                        <th class="text-white">Statut</th>
                                        {% comment %} <th class="text-white">Actions</th> {% endcomment %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for admin in utilisateurs.admins %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="rounded-circle bg-teal-glacier text-white d-flex align-items-center justify-content-center me-2" 
                                                     style="width: 35px; height: 35px; font-size: 14px;">
                                                    {{ admin.username|first|upper }}
                                                </div>
                                                <strong>{{ admin.username }}</strong>
                                            </div>
                                        </td>
                                        <td>{{ admin.first_name }} {{ admin.last_name }}</td>
                                        <td>{{ admin.email }}</td>
                                        <td>{{ admin.telephone|default:"-" }}</td>
                                        <td>{{ admin.date_joined|date:"d/m/Y" }}</td>
                                        <td>
                                            <span class="badge {% if admin.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                                {{ admin.is_active|yesno:"Actif,Inactif" }}
                                            </span>
                                        </td>
                                        {% comment %} <td>
                                            <div class="btn-group btn-group-sm">
                                                <button type="button" class="btn btn-teal-light" data-bs-toggle="modal" data-bs-target="#adminModal{{ admin.id }}" title="Détails">
                                                    <i class="fas fa-eye teal-glacier-text"></i>
                                                </button>
                                                <a href="#" class="btn btn-outline-teal" title="Modifier">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <button type="button" 
                                                    class="btn btn-outline-danger btn-sm btn-supprimer"
                                                    data-user-id="{{ admin.id }}"
                                                    data-username="{{ admin.username }}"
                                                    data-role="{{ admin.get_role_display|default:'Administrateur' }}"
                                                    title="Supprimer">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td> {% endcomment %}
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="7" class="text-center py-4">
                                            <i class="fas fa-user-shield fa-2x text-muted mb-2"></i>
                                            <p class="text-muted mb-0">Aucun administrateur</p>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Gérants -->
                    <div class="tab-pane fade" id="gerants" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="teal-glacier-bg">
                                    <tr>
                                        <th class="text-white">Utilisateur</th>
                                        <th class="text-white">Nom complet</th>
                                        <th class="text-white">Email</th>
                                        <th class="text-white">Téléphone</th>
                                        <th class="text-white">Date d'inscription</th>
                                        <th class="text-white">Statut</th>
                                        <th class="text-white">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for gerant in utilisateurs.gerants %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="rounded-circle bg-teal-glacier text-white d-flex align-items-center justify-content-center me-2" 
                                                     style="width: 35px; height: 35px; font-size: 14px;">
                                                    {{ gerant.username|first|upper }}
                                                </div>
                                                <strong>{{ gerant.username }}</strong>
                                            </div>
                                        </td>
                                        <td>{{ gerant.first_name }} {{ gerant.last_name }}</td>
                                        <td>{{ gerant.email }}</td>
                                        <td>{{ gerant.telephone|default:"-" }}</td>
                                        <td>{{ gerant.date_joined|date:"d/m/Y" }}</td>
                                        <td>
                                            <span class="badge {% if gerant.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                                {{ gerant.is_active|yesno:"Actif,Inactif" }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                               <a href="{% url 'modifier_gerant' gerant.id %}" class="btn btn-outline-teal" title="Modifier">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <a href="{% url 'supprimer_gerant' gerant.id %}" class="btn btn-outline-danger btn-sm" title="Supprimer">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="7" class="text-center py-4">
                                            <i class="fas fa-user-tie fa-2x text-muted mb-2"></i>
                                            <p class="text-muted mb-0">Aucun gérant</p>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Serveurs -->
                    <div class="tab-pane fade" id="serveurs" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="teal-glacier-bg">
                                    <tr>
                                        <th class="text-white">Utilisateur</th>
                                        <th class="text-white">Nom complet</th>
                                        <th class="text-white">Email</th>
                                        <th class="text-white">Téléphone</th>
                                        <th class="text-white">Date d'inscription</th>
                                        <th class="text-white">Statut</th>
                                        <th class="text-white">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for serveur in utilisateurs.serveurs %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="rounded-circle bg-teal-glacier text-white d-flex align-items-center justify-content-center me-2" 
                                                     style="width: 35px; height: 35px; font-size: 14px;">
                                                    {{ serveur.username|first|upper }}
                                                </div>
                                                <strong>{{ serveur.username }}</strong>
                                            </div>
                                        </td>
                                        <td>{{ serveur.first_name }} {{ serveur.last_name }}</td>
                                        <td>{{ serveur.email }}</td>
                                        <td>{{ serveur.telephone|default:"-" }}</td>
                                        <td>{{ serveur.date_joined|date:"d/m/Y" }}</td>
                                        <td>
                                            <span class="badge {% if serveur.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                                {{ serveur.is_active|yesno:"Actif,Inactif" }}
                                            </span>
                                        </td>
                                        <td>
                                           <div class="btn-group btn-group-sm">
                                               <a href="{% url 'modifier_serveur' serveur.id %}" class="btn btn-outline-teal" title="Modifier">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <a href="{% url 'supprimer_serveur' serveur.id %}" class="btn btn-outline-danger btn-sm" title="Supprimer">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="7" class="text-center py-4">
                                            <i class="fas fa-user-cog fa-2x text-muted mb-2"></i>
                                            <p class="text-muted mb-0">Aucun serveur</p>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Livreurs -->
                    <div class="tab-pane fade" id="livreurs" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="teal-glacier-bg">
                                    <tr>
                                        <th class="text-white">Utilisateur</th>
                                        <th class="text-white">Nom complet</th>
                                        <th class="text-white">Email</th>
                                        <th class="text-white">Téléphone</th>
                                        <th class="text-white">Date d'inscription</th>
                                        <th class="text-white">Statut</th>
                                        <th class="text-white">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for livreur in utilisateurs.livreurs %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="rounded-circle bg-teal-glacier text-white d-flex align-items-center justify-content-center me-2" 
                                                     style="width: 35px; height: 35px; font-size: 14px;">
                                                    {{ livreur.username|first|upper }}
                                                </div>
                                                <strong>{{ livreur.username }}</strong>
                                            </div>
                                        </td>
                                        <td>{{ livreur.first_name }} {{ livreur.last_name }}</td>
                                        <td>{{ livreur.email }}</td>
                                        <td>{{ livreur.telephone|default:"-" }}</td>
                                        <td>{{ livreur.date_joined|date:"d/m/Y" }}</td>
                                        <td>
                                            <span class="badge {% if livreur.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                                {{ livreur.is_active|yesno:"Actif,Inactif" }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                               <a href="{% url 'modifier_livreur' livreur.id %}" class="btn btn-outline-teal" title="Modifier">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <a href="{% url 'supprimer_livreur' livreur.id %}" class="btn btn-outline-danger btn-sm" title="Supprimer">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="7" class="text-center py-4">
                                            <i class="fas fa-truck fa-2x text-muted mb-2"></i>
                                            <p class="text-muted mb-0">Aucun livreur</p>
                                            <a href="{% url 'ajouter_livreur' %}" class="btn btn-teal-glacier btn-sm mt-2">
                                                <i class="fas fa-plus me-1"></i>Ajouter un livreur
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Clients -->
                    <div class="tab-pane fade" id="clients" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="teal-glacier-bg">
                                    <tr>
                                        <th class="text-white">Utilisateur</th>
                                        <th class="text-white">Nom complet</th>
                                        <th class="text-white">Email</th>
                                        <th class="text-white">Téléphone</th>
                                        <th class="text-white">Date d'inscription</th>
                                        <th class="text-white">Statut</th>
                                        <th class="text-white">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for client in utilisateurs.clients %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="rounded-circle bg-teal-glacier text-white d-flex align-items-center justify-content-center me-2" 
                                                     style="width: 35px; height: 35px; font-size: 14px;">
                                                    {{ client.username|first|upper }}
                                                </div>
                                                <strong>{{ client.username }}</strong>
                                            </div>
                                        </td>
                                        <td>{{ client.first_name }} {{ client.last_name }}</td>
                                        <td>{{ client.email }}</td>
                                        <td>{{ client.telephone|default:"-" }}</td>
                                        <td>{{ client.date_joined|date:"d/m/Y" }}</td>
                                        <td>
                                            <span class="badge {% if client.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                                {{ client.is_active|yesno:"Actif,Inactif" }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                               <a href="{% url 'modifier_client' client.id %}" class="btn btn-outline-teal" title="Modifier">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <a href="{% url 'supprimer_client' client.id %}" class="btn btn-outline-danger btn-sm" title="Supprimer">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="7" class="text-center py-4">
                                            <i class="fas fa-user fa-2x text-muted mb-2"></i>
                                            <p class="text-muted mb-0">Aucun client</p>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals pour les détails des utilisateurs -->
{% for admin in utilisateurs.admins %}
<div class="modal fade" id="adminModal{{ admin.id }}" tabindex="-1" aria-labelledby="adminModalLabel{{ admin.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header teal-glacier-bg text-white">
                <h5 class="modal-title text-white" id="adminModalLabel{{ admin.id }}">
                    <i class="fas fa-user-shield me-2"></i>
                    Détails Administrateur - {{ admin.username }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4 text-center mb-4">
                        <div class="rounded-circle bg-teal-glacier text-white d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 100px; height: 100px; font-size: 36px;">
                            {{ admin.username|first|upper }}
                        </div>
                        <h5 class="teal-glacier-text">{{ admin.username }}</h5>
                        <span class="badge bg-teal-glacier">Administrateur</span>
                    </div>
                    <div class="col-md-8">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Nom complet:</strong>
                                <p>{{ admin.first_name }} {{ admin.last_name }}</p>
                            </div>
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Email:</strong>
                                <p>{{ admin.email }}</p>
                            </div>
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Téléphone:</strong>
                                <p>{{ admin.telephone|default:"Non renseigné" }}</p>
                            </div>
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Statut:</strong>
                                <p>
                                    <span class="badge {% if admin.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                        {{ admin.is_active|yesno:"Actif,Inactif" }}
                                    </span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Date d'inscription:</strong>
                                <p>{{ admin.date_joined|date:"d/m/Y à H:i" }}</p>
                            </div>
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Dernière connexion:</strong>
                                <p>{{ admin.last_login|date:"d/m/Y à H:i"|default:"Jamais" }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-teal" data-bs-dismiss="modal">Fermer</button>
                <a href="#" class="btn btn-teal-glacier">Modifier</a>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<<!-- Modals pour les Gérants -->
{% for gerant in utilisateurs.gerants %}
<div class="modal fade" id="gerantModal{{ gerant.id }}" tabindex="-1" aria-labelledby="gerantModalLabel{{ gerant.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header teal-glacier-bg text-white">
                <h5 class="modal-title text-white" id="gerantModalLabel{{ gerant.id }}">
                    <i class="fas fa-user-tie me-2"></i>
                    Détails Gérant - {{ gerant.username }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4 text-center mb-4">
                        <div class="rounded-circle bg-teal-glacier text-white d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 100px; height: 100px; font-size: 36px;">
                            {{ gerant.username|first|upper }}
                        </div>
                        <h5 class="teal-glacier-text">{{ gerant.username }}</h5>
                        <span class="badge bg-teal-glacier">Gérant</span>
                    </div>
                    <div class="col-md-8">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Nom complet:</strong>
                                <p>{{ gerant.first_name }} {{ gerant.last_name }}</p>
                            </div>
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Email:</strong>
                                <p>{{ gerant.email }}</p>
                            </div>
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Téléphone:</strong>
                                <p>{{ gerant.telephone|default:"Non renseigné" }}</p>
                            </div>
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Statut:</strong>
                                <p>
                                    <span class="badge {% if gerant.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                        {{ gerant.is_active|yesno:"Actif,Inactif" }}
                                    </span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Date d'inscription:</strong>
                                <p>{{ gerant.date_joined|date:"d/m/Y à H:i" }}</p>
                            </div>
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Dernière connexion:</strong>
                                <p>{{ gerant.last_login|date:"d/m/Y à H:i"|default:"Jamais" }}</p>
                            </div>
                            {% if gerant.restaurant %}
                            <div class="col-12">
                                <strong class="teal-glacier-text">Restaurant assigné:</strong>
                                <p>{{ gerant.restaurant.nom }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-teal" data-bs-dismiss="modal">Fermer</button>
                <a  class="btn btn-teal-glacier">Modifier</a>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Modals pour les Serveurs -->
{% for serveur in utilisateurs.serveurs %}
<div class="modal fade" id="serveurModal{{ serveur.id }}" tabindex="-1" aria-labelledby="serveurModalLabel{{ serveur.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header teal-glacier-bg text-white">
                <h5 class="modal-title text-white" id="serveurModalLabel{{ serveur.id }}">
                    <i class="fas fa-user-cog me-2"></i>
                    Détails Serveur - {{ serveur.username }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4 text-center mb-4">
                        <div class="rounded-circle bg-teal-glacier text-white d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 100px; height: 100px; font-size: 36px;">
                            {{ serveur.username|first|upper }}
                        </div>
                        <h5 class="teal-glacier-text">{{ serveur.username }}</h5>
                        <span class="badge bg-teal-glacier">Serveur</span>
                    </div>
                    <div class="col-md-8">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Nom complet:</strong>
                                <p>{{ serveur.first_name }} {{ serveur.last_name }}</p>
                            </div>
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Email:</strong>
                                <p>{{ serveur.email }}</p>
                            </div>
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Téléphone:</strong>
                                <p>{{ serveur.telephone|default:"Non renseigné" }}</p>
                            </div>
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Statut:</strong>
                                <p>
                                    <span class="badge {% if serveur.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                        {{ serveur.is_active|yesno:"Actif,Inactif" }}
                                    </span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Date d'inscription:</strong>
                                <p>{{ serveur.date_joined|date:"d/m/Y à H:i" }}</p>
                            </div>
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Dernière connexion:</strong>
                                <p>{{ serveur.last_login|date:"d/m/Y à H:i"|default:"Jamais" }}</p>
                            </div>
                            {% if serveur.restaurant %}
                            <div class="col-12">
                                <strong class="teal-glacier-text">Restaurant assigné:</strong>
                                <p>{{ serveur.restaurant.nom }}</p>
                            </div>
                            {% endif %}
                            {% if serveur.gerant_referent %}
                            <div class="col-12">
                                <strong class="teal-glacier-text">Gérant référent:</strong>
                                <p>{{ serveur.gerant_referent.get_full_name }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-teal" data-bs-dismiss="modal">Fermer</button>
                <a class="btn btn-teal-glacier">Modifier</a>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Modals pour les Livreurs -->
{% for livreur in utilisateurs.livreurs %}
<div class="modal fade" id="livreurModal{{ livreur.id }}" tabindex="-1" aria-labelledby="livreurModalLabel{{ livreur.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header teal-glacier-bg text-white">
                <h5 class="modal-title text-white" id="livreurModalLabel{{ livreur.id }}">
                    <i class="fas fa-truck me-2"></i>
                    Détails Livreur - {{ livreur.username }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4 text-center mb-4">
                        <div class="rounded-circle bg-teal-glacier text-white d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 100px; height: 100px; font-size: 36px;">
                            {{ livreur.username|first|upper }}
                        </div>
                        <h5 class="teal-glacier-text">{{ livreur.username }}</h5>
                        <span class="badge bg-teal-glacier">Livreur</span>
                    </div>
                    <div class="col-md-8">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Nom complet:</strong>
                                <p>{{ livreur.first_name }} {{ livreur.last_name }}</p>
                            </div>
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Email:</strong>
                                <p>{{ livreur.email }}</p>
                            </div>
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Téléphone:</strong>
                                <p>{{ livreur.telephone|default:"Non renseigné" }}</p>
                            </div>
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Statut:</strong>
                                <p>
                                    <span class="badge {% if livreur.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                        {{ livreur.is_active|yesno:"Actif,Inactif" }}
                                    </span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Date d'inscription:</strong>
                                <p>{{ livreur.date_joined|date:"d/m/Y à H:i" }}</p>
                            </div>
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Dernière connexion:</strong>
                                <p>{{ livreur.last_login|date:"d/m/Y à H:i"|default:"Jamais" }}</p>
                            </div>
                            {% if livreur.vehicule_type %}
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Type de véhicule:</strong>
                                <p>{{ livreur.vehicule_type }}</p>
                            </div>
                            {% endif %}
                            {% if livreur.plaque_immatriculation %}
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Plaque d'immatriculation:</strong>
                                <p>{{ livreur.plaque_immatriculation }}</p>
                            </div>
                            {% endif %}
                            {% if livreur.zone_livraison %}
                            <div class="col-12">
                                <strong class="teal-glacier-text">Zone de livraison:</strong>
                                <p>{{ livreur.zone_livraison }}</p>
                            </div>
                            {% endif %}
                            <div class="col-12">
                                <strong class="teal-glacier-text">Statut de disponibilité:</strong>
                                <p>
                                    <span class="badge {% if livreur.est_disponible %}bg-success{% else %}bg-warning{% endif %}">
                                        {{ livreur.est_disponible|yesno:"Disponible,Indisponible" }}
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-teal" data-bs-dismiss="modal">Fermer</button>
                <a href="{% url 'modifier_livreur' livreur.id %}" class="btn btn-teal-glacier">Modifier</a>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Modals pour les Clients -->
{% for client in utilisateurs.clients %}
<div class="modal fade" id="clientModal{{ client.id }}" tabindex="-1" aria-labelledby="clientModalLabel{{ client.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header teal-glacier-bg text-white">
                <h5 class="modal-title text-white" id="clientModalLabel{{ client.id }}">
                    <i class="fas fa-user me-2"></i>
                    Détails Client - {{ client.username }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4 text-center mb-4">
                        <div class="rounded-circle bg-teal-glacier text-white d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 100px; height: 100px; font-size: 36px;">
                            {{ client.username|first|upper }}
                        </div>
                        <h5 class="teal-glacier-text">{{ client.username }}</h5>
                        <span class="badge bg-teal-glacier">Client</span>
                    </div>
                    <div class="col-md-8">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Nom complet:</strong>
                                <p>{{ client.first_name }} {{ client.last_name }}</p>
                            </div>
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Email:</strong>
                                <p>{{ client.email }}</p>
                            </div>
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Téléphone:</strong>
                                <p>{{ client.telephone|default:"Non renseigné" }}</p>
                            </div>
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Statut:</strong>
                                <p>
                                    <span class="badge {% if client.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                        {{ client.is_active|yesno:"Actif,Inactif" }}
                                    </span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Date d'inscription:</strong>
                                <p>{{ client.date_joined|date:"d/m/Y à H:i" }}</p>
                            </div>
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Dernière connexion:</strong>
                                <p>{{ client.last_login|date:"d/m/Y à H:i"|default:"Jamais" }}</p>
                            </div>
                            {% if client.adresse %}
                            <div class="col-12">
                                <strong class="teal-glacier-text">Adresse:</strong>
                                <p>{{ client.adresse }}</p>
                            </div>
                            {% endif %}
                            {% if client.ville %}
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Ville:</strong>
                                <p>{{ client.ville }}</p>
                            </div>
                            {% endif %}
                            {% if client.code_postal %}
                            <div class="col-md-6">
                                <strong class="teal-glacier-text">Code postal:</strong>
                                <p>{{ client.code_postal }}</p>
                            </div>
                            {% endif %}
                            <div class="col-12">
                                <strong class="teal-glacier-text">Préférences:</strong>
                                <p>
                                    <span class="badge {% if client.newsletter_abonne %}bg-info{% else %}bg-secondary{% endif %} me-1">
                                        Newsletter: {{ client.newsletter_abonne|yesno:"Oui,Non" }}
                                    </span>
                                    {% if client.preferences_alimentaires %}
                                    <span class="badge bg-warning">
                                        Préférences: {{ client.preferences_alimentaires }}
                                    </span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-teal" data-bs-dismiss="modal">Fermer</button>
                <a  class="btn btn-teal-glacier">Modifier</a>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Modal de confirmation de suppression unique -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title text-white" id="confirmationModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Confirmer la suppression
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-trash-alt fa-3x text-danger mb-3"></i>
                <h5 class="text-danger">Êtes-vous sûr de vouloir supprimer cet utilisateur ?</h5>
                <p class="text-muted" id="userInfo"></p>
                <div class="alert alert-warning mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Cette action est irréversible. Toutes les données associées seront perdues.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-teal" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Annuler
                </button>
               <button class="btn-supprimer" 
        data-user-id="{{ user.id }}" 
        data-username="{{ user.username }}" 
        data-role="{{ user.get_role_display }}">
    <i class="fas fa-trash"></i>
</button>
            </div>
        </div>
    </div>
</div>

<style>
    :root {
        --teal-glacier: #00B8B5;
        --teal-dark: #00827F;
        --teal-light: rgba(0, 184, 181, 0.1);
    }

    .teal-glacier-text {
        color: var(--teal-glacier) !important;
    }

    .teal-glacier-bg {
        background-color: var(--teal-glacier) !important;
    }

    .bg-teal-glacier {
        background-color: var(--teal-glacier) !important;
    }

    .btn-teal-glacier {
        background-color: var(--teal-glacier);
        border-color: var(--teal-glacier);
        color: white;
        transition: all 0.3s ease;
    }

    .btn-teal-glacier:hover {
        background-color: white;
        border-color: var(--teal-glacier);
        color: var(--teal-glacier);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 184, 181, 0.3);
    }

    .btn-outline-teal {
        border-color: var(--teal-glacier);
        color: var(--teal-glacier);
        background-color: transparent;
        transition: all 0.3s ease;
    }

    .btn-outline-teal:hover {
        background-color: var(--teal-glacier);
        border-color: var(--teal-glacier);
        color: white;
        transform: translateY(-1px);
    }

    .card-hover {
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .card-hover:hover {
        transform: translateY(-3px);
        box-shadow: 0 0.5rem 1.5rem rgba(0, 184, 181, 0.2) !important;
    }

    .table-hover tbody tr:hover {
        background-color: var(--teal-light) !important;
        transform: translateX(2px);
    }

    .nav-tabs .nav-link.active {
        color: var(--teal-glacier);
        background-color: transparent;
        border-bottom: 3px solid var(--teal-glacier);
    }

    .nav-tabs .nav-link:hover {
        color: var(--teal-glacier);
        border-bottom: 3px solid var(--teal-light);
    }
</style>

<script>
    // Debug initial
    console.log('=== SCRIPT UTILISATEURS CHARGÉ ===');

    // Variables globales pour la suppression
    let userToDelete = null;
    let userRowToDelete = null;

    // Fonction pour préparer la suppression
    function preparerSuppression(userId, username, role, rowElement) {
        console.log('🟡 Préparation suppression:', { userId, username, role });
        
        userToDelete = userId;
        userRowToDelete = rowElement;
        
        // Mettre à jour les informations dans la modal
        document.getElementById('userInfo').textContent = `Utilisateur: ${username} (${role})`;
        
        // Afficher la modal
        const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
        modal.show();
        
        console.log('🟡 Modal ouverte pour suppression');
    }

    // Fonction pour exécuter la suppression
    function executerSuppression() {
        console.log('🟡 Début suppression, userToDelete:', userToDelete);
        
        if (!userToDelete) {
            console.log('🔴 Aucun utilisateur à supprimer');
            return;
        }
        
        // Récupérer le CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (!csrfToken) {
            console.log('🔴 CSRF token non trouvé');
            afficherMessageErreur('Erreur de sécurité. Veuillez recharger la page.');
            return;
        }
        
        const deleteBtn = document.getElementById('confirmDeleteBtn');
        const originalText = deleteBtn.innerHTML;
        
        console.log('🟡 Envoi requête suppression...');
        
        // Afficher indicateur de chargement
        deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Suppression...';
        deleteBtn.disabled = true;
        
        // IMPORTANT: Choisissez UNE seule URL selon votre configuration
        // Option 1: Si votre app s'appelle "gestion_admin"
        const url = `/gestion_admin/utilisateurs/supprimer/${userToDelete}/`;
        // Option 2: Si votre app s'appelle "gestion" 
        // const url = `/gestion/utilisateurs/supprimer/${userToDelete}/`;
        
        console.log('🟡 URL:', url);
        
        // Envoyer la requête AJAX
        fetch(url, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken,
            }
        })
        .then(response => {
            console.log('🟡 Réponse reçue, status:', response.status);
            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('🟡 Données reçues:', data);
            
            if (data.success) {
                console.log('🟢 Suppression réussie');
                afficherMessageSucces(data.message);
                
                // Animation de suppression de la ligne
                if (userRowToDelete) {
                    userRowToDelete.style.transition = 'all 0.5s ease';
                    userRowToDelete.style.opacity = '0';
                    userRowToDelete.style.transform = 'translateX(-100%)';
                    setTimeout(() => {
                        if (userRowToDelete.parentNode) {
                            userRowToDelete.remove();
                            console.log('🟢 Ligne supprimée du DOM');
                        }
                    }, 500);
                }
                
                // Recharger la page après un délai pour mettre à jour les compteurs
                setTimeout(() => {
                    console.log('🟢 Rechargement de la page');
                    location.reload();
                }, 1500);
                
            } else {
                console.log('🔴 Erreur suppression:', data.message);
                afficherMessageErreur(data.message);
            }
        })
        .catch(error => {
            console.error('🔴 Erreur fetch:', error);
            afficherMessageErreur('Erreur réseau: ' + error.message);
        })
        .finally(() => {
            // Restaurer le bouton
            deleteBtn.innerHTML = originalText;
            deleteBtn.disabled = false;
            
            // Fermer la modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('confirmationModal'));
            if (modal) {
                modal.hide();
                console.log('🟡 Modal fermée');
            }
            
            // Réinitialiser
            userToDelete = null;
            userRowToDelete = null;
        });
    }

    // Fonctions d'affichage des messages
    function afficherMessageSucces(message) {
        console.log('🟢 Message succès:', message);
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show';
        alertDiv.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Utiliser messagesContainer s'il existe, sinon le container principal
        const container = document.getElementById('messagesContainer') || document.querySelector('.container-fluid');
        container.insertBefore(alertDiv, container.firstChild);
        
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    function afficherMessageErreur(message) {
        console.log('🔴 Message erreur:', message);
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show';
        alertDiv.innerHTML = `
            <i class="fas fa-exclamation-circle me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const container = document.getElementById('messagesContainer') || document.querySelector('.container-fluid');
        container.insertBefore(alertDiv, container.firstChild);
        
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // Événements au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
        console.log('=== DOM COMPLÈTEMENT CHARGÉ ===');
        
        // Événement pour le bouton de confirmation
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        if (confirmBtn) {
            confirmBtn.addEventListener('click', executerSuppression);
            console.log('🟡 Bouton confirmation lié');
        } else {
            console.log('🔴 Bouton confirmation NON TROUVÉ');
        }
        
        // Vérifier que les boutons de suppression existent
        const supprimerBtns = document.querySelectorAll('.btn-supprimer');
        console.log(`🟡 ${supprimerBtns.length} boutons de suppression trouvés`);
        
        // Gestion des clics sur les boutons de suppression
        document.addEventListener('click', function(e) {
            const btnSupprimer = e.target.closest('.btn-supprimer');
            
            if (btnSupprimer) {
                e.preventDefault();
                console.log('🟡 Clic sur bouton suppression détecté');
                
                const userId = btnSupprimer.dataset.userId;
                const username = btnSupprimer.dataset.username;
                const role = btnSupprimer.dataset.role;
                const row = btnSupprimer.closest('tr');
                
                console.log('🟡 Données du bouton:', { userId, username, role });
                
                if (!userId) {
                    console.log('🔴 userId manquant dans data-user-id');
                    afficherMessageErreur('Erreur: ID utilisateur manquant');
                    return;
                }
                
                preparerSuppression(userId, username, role, row);
            }
        });
        
        // Debug: Afficher tous les boutons de suppression
        supprimerBtns.forEach((btn, index) => {
            console.log(`Bouton ${index + 1}:`, {
                userId: btn.dataset.userId,
                username: btn.dataset.username,
                role: btn.dataset.role
            });
        });

        // Tooltips Bootstrap
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        console.log(`🟡 ${tooltipList.length} tooltips initialisés`);

        // Sauvegarder l'onglet actif
        const tabLinks = document.querySelectorAll('#usersTab button[data-bs-toggle="tab"]');
        tabLinks.forEach(tab => {
            tab.addEventListener('click', function() {
                localStorage.setItem('activeUserTab', this.id);
                console.log('🟡 Onglet sauvegardé:', this.id);
            });
        });

        // Restaurer l'onglet actif
        const activeTabId = localStorage.getItem('activeUserTab');
        if (activeTabId) {
            const activeTab = document.getElementById(activeTabId);
            if (activeTab) {
                const tab = new bootstrap.Tab(activeTab);
                tab.show();
                console.log('🟡 Onglet restauré:', activeTabId);
            }
        }
    });
</script>
{% endblock %}