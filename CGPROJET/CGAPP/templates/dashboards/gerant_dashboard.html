{% extends 'dashboards/base.html' %}
{% load static %}

{% block title %}Dashboard Gérant - Glacier Royale{% endblock %}

{% block body %}

<style>
.btn-outline-info:hover{
    color: white
}

.btn-outline-warning:hover{
    color: white
}
.btn-sm:hover{
    color: white
}
</style>

<div class="container-fluid pt-4 px-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="bg-light rounded p-4">
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <h1 class="h3 mb-0">Dashboard Gérant</h1>
                    
                </div>
                <p class="text-muted mb-0">Bienvenue, {{ request.user.get_full_name|default:request.user.username }}</p>
            </div>
        </div>
    </div>

    <!-- Statistiques Générales -->
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-sm-6">
            <div class="bg-light rounded d-flex align-items-center justify-content-between p-4">
                <div>
                    <h6 class="mb-2">Produits Total</h6>
                    <h4 class="mb-0">{{ stats_generales.total_produits }}</h4>
                </div>
                <i class="fas fa-ice-cream fa-3x text-primary"></i>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6">
            <div class="bg-light rounded d-flex align-items-center justify-content-between p-4">
                <div>
                    <h6 class="mb-2">Stock Faible</h6>
                    <h4 class="mb-0 text-warning">{{ stats_generales.produits_stock_faible }}</h4>
                </div>
                <i class="fas fa-exclamation-triangle fa-3x text-warning"></i>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6">
            <div class="bg-light rounded d-flex align-items-center justify-content-between p-4">
                <div>
                    <h6 class="mb-2">Rupture de Stock</h6>
                    <h4 class="mb-0 text-danger">{{ stats_generales.produits_rupture }}</h4>
                </div>
                <i class="fas fa-times-circle fa-3x text-danger"></i>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6">
            <div class="bg-light rounded d-flex align-items-center justify-content-between p-4">
                <div>
                    <h6 class="mb-2">Commandes Total</h6>
                    <h4 class="mb-0">{{ stats_generales.total_commandes }}</h4>
                </div>
                <i class="fas fa-shopping-cart fa-3x text-success"></i>
            </div>
        </div>
    </div>

    <!-- Deuxième ligne de statistiques -->
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-sm-6">
            <div class="bg-light rounded d-flex align-items-center justify-content-between p-4">
                <div>
                    <h6 class="mb-2">En Attente</h6>
                    <h4 class="mb-0 text-warning">{{ stats_generales.commandes_attente }}</h4>
                </div>
                <i class="fas fa-clock fa-3x text-warning"></i>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6">
            <div class="bg-light rounded d-flex align-items-center justify-content-between p-4">
                <div>
                    <h6 class="mb-2">Serveurs Actifs</h6>
                    <h4 class="mb-0">{{ stats_generales.total_serveurs }}</h4>
                </div>
                <i class="fas fa-users fa-3x text-info"></i>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6">
            <div class="bg-light rounded d-flex align-items-center justify-content-between p-4">
                <div>
                    <h6 class="mb-2">Ventes Aujourd'hui</h6>
                    <h4 class="mb-0 text-success">{{ stats_ventes.aujourdhui|floatformat:0 }} FCFA</h4>
                </div>
                <i class="fas fa-money-bill-wave fa-3x text-success"></i>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6">
            <div class="bg-light rounded d-flex align-items-center justify-content-between p-4">
                <div>
                    <h6 class="mb-2">Ventes Ce Mois</h6>
                    <h4 class="mb-0 text-primary">{{ stats_ventes.mois|floatformat:0 }} FCFA</h4>
                </div>
                <i class="fas fa-chart-line fa-3x text-primary"></i>
            </div>
        </div>
    </div>

   <!-- Actions Rapides -->
<div class="row mb-4">
    <div class="col-12">
        <div class="bg-light rounded p-4">
            <h5 class="mb-4">
                <i class="fas fa-bolt text-warning me-2"></i>
                Actions Rapides
            </h5>
            <div class="row g-3">
                <div class="col-md-3 col-6">
                    <a href="{% url 'gestion_stocks_avancee' %}" class="btn btn-outline-primary w-100 h-100 d-flex flex-column align-items-center justify-content-center p-3">
                        <i class="fas fa-boxes fa-2x mb-2"></i>
                        <span class="text-center">Gestion des Stocks</span>
                    </a>
                </div>
                <div class="col-md-3 col-6">
                    <a href="{% url 'liste_serveurs' %}" class="btn btn-outline-info w-100 h-100 d-flex flex-column align-items-center justify-content-center p-3">
                        <i class="fas fa-user-tie fa-2x mb-2"></i>
                        <span class="text-center ">Supervision Serveurs</span>
                    </a>
                </div>
                <div class="col-md-3 col-6">
                    <a href="{% url 'liste_produits' %}" class="btn btn-outline-success w-100 h-100 d-flex flex-column align-items-center justify-content-center p-3">
                        <i class="fas fa-ice-cream fa-2x mb-2"></i>
                        <span class="text-center">Gérer Produits</span>
                    </a>
                </div>
                <div class="col-md-3 col-6">
                    <a href="{% url 'gestion_commandes_admin' %}" class="btn btn-outline-warning w-100 h-100 d-flex flex-column align-items-center justify-content-center p-3">
                        <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                        <span class="text-center">Gestion Commandes</span>
                    </a>
                </div>
            </div>
            
            {% comment %} <!-- Deuxième ligne d'actions -->
            <div class="row g-3 mt-2">
                <div class="col-md-3 col-6">
                    <a href="{% url 'statistiques_ventes' %}" class="btn btn-outline-danger w-100 h-100 d-flex flex-column align-items-center justify-content-center p-3">
                        <i class="fas fa-chart-line fa-2x mb-2"></i>
                        <span class="text-center">Statistiques Ventes</span>
                    </a>
                </div>
                <div class="col-md-3 col-6">
                    <a href="{% url 'gestion_financiere_gerant' %}" class="btn btn-outline-dark w-100 h-100 d-flex flex-column align-items-center justify-content-center p-3">
                        <i class="fas fa-money-bill-wave fa-2x mb-2"></i>
                        <span class="text-center">Finances</span>
                    </a>
                </div>
                <div class="col-md-3 col-6">
                    <a href="{% url 'gestion_categories' %}" class="btn btn-outline-secondary w-100 h-100 d-flex flex-column align-items-center justify-content-center p-3">
                        <i class="fas fa-tags fa-2x mb-2"></i>
                        <span class="text-center">Catégories</span>
                    </a>
                </div>
                <div class="col-md-3 col-6">
                    <a href="{% url 'admin:index' %}" class="btn btn-outline-purple w-100 h-100 d-flex flex-column align-items-center justify-content-center p-3">
                        <i class="fas fa-cogs fa-2x mb-2"></i>
                        <span class="text-center">Administration</span>
                    </a>
                </div>
            </div> {% endcomment %}
        </div>
    </div>
</div>

    <div class="row g-4">
        <!-- Produits Populaires -->
        <div class="col-xl-6">
            <div class="bg-light rounded p-4">
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <h5 class="mb-0">Produits Populaires</h5>
                    <a href="{% url 'liste_produits' %}" class="btn btn-sm btn-primary">Voir tous</a>
                </div>
                {% if produits_populaires %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th scope="col">Produit</th>
                                <th scope="col">Prix</th>
                                <th scope="col">Stock</th>
                                <th scope="col">Statut</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for produit in produits_populaires %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        {% if produit.image %}
                                        <img src="{{ produit.image.url }}" alt="{{ produit.nom }}" class="rounded me-3" style="width: 40px; height: 40px; object-fit: cover;">
                                        {% else %}
                                        <div class="bg-secondary rounded me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                            <i class="fas fa-ice-cream text-white"></i>
                                        </div>
                                        {% endif %}
                                        <div>
                                            <h6 class="mb-0">{{ produit.nom }}</h6>
                                            <small class="text-muted">{{ produit.categorie.nom|default:"Non catégorisé" }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ produit.prix }} FCFA</td>
                                <td>{{ produit.quantite_disponible }}</td>
                                <td>
                                    {% if produit.en_stock %}
                                        {% if produit.stock_faible %}
                                            <span class="badge bg-warning">Faible</span>
                                        {% else %}
                                            <span class="badge bg-success">En stock</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-danger">Rupture</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-ice-cream fa-3x text-muted mb-3"></i>
                    <p class="text-muted mb-0">Aucun produit populaire pour le moment</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Commandes Récentes -->
        <div class="col-xl-6">
            <div class="bg-light rounded p-4">
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <h5 class="mb-0">Commandes Récentes</h5>
                    <a href="{% url 'gestion_commandes_admin' %}" class="btn btn-sm btn-primary">Voir toutes</a>
                </div>
                {% if commandes_recentes %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th scope="col">#ID</th>
                                <th scope="col">Client</th>
                                <th scope="col">Total</th>
                                <th scope="col">Statut</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for commande in commandes_recentes %}
                            <tr>
                                <td><strong>#{{ commande.id }}</strong></td>
                                <td>{{ commande.utilisateur.username }}</td>
                                <td>{{ commande.total }} FCFA</td>
                                <td>
                                    {% if commande.statut == 'livree' %}
                                        <span class="badge bg-success">Livrée</span>
                                    {% elif commande.statut == 'en_traitement' %}
                                        <span class="badge bg-warning">En traitement</span>
                                    {% elif commande.statut == 'en_attente' %}
                                        <span class="badge bg-secondary">En attente</span>
                                    {% else %}
                                        <span class="badge bg-danger">{{ commande.get_statut_display }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                    <p class="text-muted mb-0">Aucune commande récente</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Supervision Serveurs -->
    <div class="row g-4 mt-4">
        <div class="col-12">
            <div class="bg-light rounded p-4">
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <h5 class="mb-0">Supervision Serveurs</h5>
                    <a href="{% url 'liste_serveurs' %}" class="btn btn-sm btn-primary">Voir détails</a>
                </div>
                {% if serveurs_actifs %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th scope="col">Serveur</th>
                                <th scope="col">Email</th>
                                <th scope="col">Commandes Traitées</th>
                                <th scope="col">Dernière Activité</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for serveur in serveurs_actifs %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="bg-primary rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                            <i class="fas fa-user text-white"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">{{ serveur.utilisateur.get_full_name|default:serveur.utilisateur.username }}</h6>
                                            <small class="text-muted">{{ serveur.utilisateur.role }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ serveur.utilisateur.email }}</td>
                                <td>
                                    <span class="badge bg-primary">{{ serveur.commandes_traitees|default:0 }}</span>
                                </td>
                                <td>
                                    {% if serveur.derniere_action %}
                                        <small class="text-muted">{{ serveur.derniere_action|timesince }}</small>
                                    {% else %}
                                        <span class="text-muted">Aucune activité</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{% url 'rapport_serveur' serveur.id %}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-chart-bar me-1"></i>Rapport
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <p class="text-muted mb-0">Aucun serveur actif</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Historique des Actions -->
    <div class="row g-4 mt-4">
        <div class="col-12">
            <div class="bg-light rounded p-4">
                <h5 class="mb-4">Historique des Actions Récentes</h5>
                {% if actions_recentes %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th scope="col">Utilisateur</th>
                                <th scope="col">Action</th>
                                <th scope="col">Objet</th>
                                <th scope="col">Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for action in actions_recentes %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="bg-info rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 35px; height: 35px;">
                                            <i class="fas fa-user text-white"></i>
                                        </div>
                                        <span>{{ action.utilisateur.username }}</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge 
                                        {% if action.type_action == 'creation' %}bg-success
                                        {% elif action.type_action == 'modification' %}bg-warning
                                        {% elif action.type_action == 'suppression' %}bg-danger
                                        {% else %}bg-info{% endif %}">
                                        {{ action.get_type_action_display }}
                                    </span>
                                </td>
                                <td>{{ action.objet_concerne|default:"Système" }}</td>
                                <td>
                                    <small class="text-muted">{{ action.date_action|date:"d/m/Y H:i" }}</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-history fa-3x text-muted mb-3"></i>
                    <p class="text-muted mb-0">Aucune action récente</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}